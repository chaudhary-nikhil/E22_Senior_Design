<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .status {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            text-align: center;
            font-weight: bold;
        }

        .status.connected {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .status.disconnected {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .ble-controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 24px;
            margin: 0 10px;
            border: 1px solid #ccc;
            background: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 16px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .data-section {
            margin-bottom: 30px;
            max-width: 400px;
        }

        .data-section h3 {
            background: #e9ecef;
            padding: 10px;
            margin: 0 0 10px 0;
            border: 1px solid #dee2e6;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .data-row:last-child {
            border-bottom: none;
        }

        .data-label {
            font-weight: bold;
        }

        .data-value {
            font-family: monospace;
            color: #0066cc;
        }

        .chart-section {
            margin: 20px 0;
        }

        .chart-container {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            height: 300px;
        }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .info-box h4 {
            margin-top: 0;
            color: #004085;
        }

        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BLE Dashboard</h1>

        <div class="status disconnected" id="status">
            <span id="status-text">Disconnected - Click "Connect to ESP32" to start</span>
        </div>

        <div class="ble-controls">
            <button id="connectBtn" onclick="connectBLE()">Connect to ESP32</button>
            <button id="disconnectBtn" onclick="disconnectBLE()" disabled>Disconnect</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="data-rate">0</div>
                <div class="stat-label">Data Rate (Hz)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-samples">0</div>
                <div class="stat-label">Total Samples</div>
            </div>
        </div>

        <div class="data-section">
            <h3>Accelerometer Data (m/sÂ²)</h3>
            <div class="data-row">
                <span class="data-label">X-axis (ax):</span>
                <span class="data-value" id="ax">0.000</span>
            </div>
            <div class="data-row">
                <span class="data-label">Y-axis (ay):</span>
                <span class="data-value" id="ay">0.000</span>
            </div>
            <div class="data-row">
                <span class="data-label">Z-axis (az):</span>
                <span class="data-value" id="az">0.000</span>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-container">
                <canvas id="accelChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // BLE UUIDs matching ESP32 implementation
        const SERVICE_UUID = 0x00FF; // 16-bit service UUID
        const IMU_CHARACTERISTIC_UUID = 0xFF01; // 16-bit characteristic UUID

        // BLE variables
        let bleDevice = null;
        let bleServer = null;
        let imuCharacteristic = null;

        // Chart variables
        const maxDataPoints = 50;
        let timeLabels = [];
        let accelData = { x: [], y: [], z: [] };

        // Statistics
        let totalSamples = 0;
        let lastDataTime = 0;
        let dataRateHistory = [];

        // Initialize charts
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                animation: false,
                scales: {
                    x: {
                        ticks: { maxRotation: 45, minRotation: 45, maxTicksLimit: 10 }
                    },
                    y: {
                        ticks: { stepSize: 2 }
                    }
                },
                plugins: {
                    legend: { display: true }
                }
            };

            // Acceleration chart
            const accelCtx = document.getElementById('accelChart').getContext('2d');
            window.accelChart = new Chart(accelCtx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'X', data: accelData.x,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.4, pointRadius: 0, borderWidth: 2
                        },
                        {
                            label: 'Y', data: accelData.y,
                            borderColor: 'rgb(54, 162, 235)',
                            tension: 0.4, pointRadius: 0, borderWidth: 2
                        },
                        {
                            label: 'Z', data: accelData.z,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.4, pointRadius: 0, borderWidth: 2
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: { ...commonOptions.scales, y: { min: -2, max: 12 } }
                }
            });

        }

        // Connect to BLE device
        async function connectBLE() {
            try {
                updateStatus('Scanning for devices...', 'disconnected');
                
                // Request BLE device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [
                        { name: 'FormSync' }
                    ],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('Connecting to ' + bleDevice.name + '...', 'disconnected');

                // Connect to GATT server
                updateStatus('Connecting to GATT server...', 'disconnected');
                bleServer = await bleDevice.gatt.connect();
                updateStatus('GATT connected, discovering services...', 'disconnected');

                // Get service and characteristic
                console.log('Getting primary service:', SERVICE_UUID);
                const service = await bleServer.getPrimaryService(SERVICE_UUID);
                console.log('Service found, getting characteristic:', IMU_CHARACTERISTIC_UUID);
                imuCharacteristic = await service.getCharacteristic(IMU_CHARACTERISTIC_UUID);
                console.log('Characteristic found');

                // Start notifications
                updateStatus('Starting notifications...', 'disconnected');
                await imuCharacteristic.startNotifications();
                imuCharacteristic.addEventListener('characteristicvaluechanged', handleIMUData);
                
                updateStatus('Connected to ' + bleDevice.name, 'connected');
                console.log('BLE connection fully established');

                // Update UI
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;

                console.log('BLE connected successfully');

            } catch (error) {
                console.error('BLE connection error:', error);
                updateStatus('Connection failed: ' + error.message, 'disconnected');
                alert('Failed to connect: ' + error.message + '\n\nMake sure:\n1. Your ESP32 is powered on\n2. BLE is enabled on ESP32\n3. You are using Chrome/Edge browser');
            }
        }

        // Disconnect from BLE device
        async function disconnectBLE() {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
            bleDevice = null;
            bleServer = null;
            imuCharacteristic = null;

            updateStatus('Disconnected', 'disconnected');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        }

        // Handle incoming IMU data from BLE
        function handleIMUData(event) {
            const value = event.target.value;
            
            // Parse the data (assuming 7 floats: t_ms, ax, ay, az, gx, gy, gz)
            // Each float is 4 bytes, total 28 bytes
            if (value.byteLength >= 28) {
                const dataView = new DataView(value.buffer);
                
                const data = {
                    t_ms: dataView.getUint32(0, true),
                    ax: dataView.getFloat32(4, true),
                    ay: dataView.getFloat32(8, true),
                    az: dataView.getFloat32(12, true),
                    gx: dataView.getFloat32(16, true),
                    gy: dataView.getFloat32(20, true),
                    gz: dataView.getFloat32(24, true)
                };

                updateDisplay(data);
                updateCharts(data);
                updateStats();
            }
        }

        // Update status display
        function updateStatus(message, state) {
            const statusDiv = document.getElementById('status');
            document.getElementById('status-text').textContent = message;
            statusDiv.className = 'status ' + state;
        }

        // Update data display
        function updateDisplay(data) {
            document.getElementById('ax').textContent = data.ax.toFixed(3);
            document.getElementById('ay').textContent = data.ay.toFixed(3);
            document.getElementById('az').textContent = data.az.toFixed(3);
        }

        // Update charts
        function updateCharts(data) {
            const timeLabel = new Date().toLocaleTimeString();
            
            timeLabels.push(timeLabel);
            accelData.x.push(data.ax);
            accelData.y.push(data.ay);
            accelData.z.push(data.az);

            if (timeLabels.length > maxDataPoints) {
                timeLabels.shift();
                accelData.x.shift();
                accelData.y.shift();
                accelData.z.shift();
            }

            window.accelChart.update('none');
        }

        // Update statistics
        function updateStats() {
            totalSamples++;
            const currentTime = Date.now();
            
            if (lastDataTime > 0) {
                const timeDiff = currentTime - lastDataTime;
                const rate = 1000 / timeDiff;
                dataRateHistory.push(rate);
                if (dataRateHistory.length > 10) {
                    dataRateHistory.shift();
                }
                const avgRate = dataRateHistory.reduce((a, b) => a + b, 0) / dataRateHistory.length;
                document.getElementById('data-rate').textContent = avgRate.toFixed(1);
            }
            lastDataTime = currentTime;
            
            document.getElementById('total-samples').textContent = totalSamples;
        }

        // Check Web Bluetooth support
        function checkBLESupport() {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth API is not supported in this browser.\n\nPlease use:\n- Chrome (Desktop or Android)\n- Edge (Desktop)\n- Opera (Desktop or Android)\n\nNote: Safari and Firefox do not support Web Bluetooth.');
                document.getElementById('connectBtn').disabled = true;
                updateStatus('Web Bluetooth not supported in this browser', 'disconnected');
                return false;
            }
            return true;
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            checkBLESupport();
            initCharts();
        });

        // Handle device disconnection
        function onDisconnected() {
            updateStatus('Device disconnected', 'disconnected');
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        }
    </script>
</body>
</html>
